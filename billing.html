<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html">üìä Dashboard</a></li>
            <li><a href="patients.html">üë• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
            <li><a href="appointments.html">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
            <li><a href="records.html">üìã ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></li>
            <li><a href="billing.html" class="active">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>üí∞ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h2>
            <button class="btn btn-primary" onclick="openAddBillingModal()">+ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value" id="todayIncome">0 ‡∏ø</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value" id="monthlyIncome">0 ‡∏ø</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
                <div class="stat-value" id="todayBillCount">0</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
            </div>
            <div class="card-body">
                <div class="search-bar">
                    <input type="text" id="searchBill" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à, HN, ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢...">
                    <input type="date" id="searchDate" class="form-input">
                    <button class="btn btn-secondary" onclick="clearSearch()">‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h3>
                <span class="badge" id="billCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>HN</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</th>
                                <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="billTableBody">
                            <tr>
                                <td colspan="8" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Billing Modal -->
    <div id="billingModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà</h3>
                <span class="close" onclick="closeBillingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="billingForm">
                    <input type="hidden" id="billingId">

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</label>
                            <input type="text" id="receiptNumber" class="form-input" readonly>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="required">*</span></label>
                            <input type="date" id="billDate" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
                        <select id="patientSelect" class="form-input" required onchange="updateBillPatientInfo()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                        </select>
                        <div id="billPatientInfo" class="patient-info"></div>
                    </div>

                    <div class="form-group">
                        <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h4>
                        <div id="billItems">
                            <!-- Items will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addBillItem()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                    </div>

                    <div class="bill-summary">
                        <div class="summary-row">
                            <span>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                            <span id="subtotal">0.00</span>
                            <span>‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="summary-row">
                            <label>
                                ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:
                                <input type="number" id="discount" class="form-input-sm" value="0" min="0" step="0.01" onchange="calculateTotal()">
                            </label>
                            <span id="discountAmount">0.00</span>
                            <span>‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        <div class="summary-row total-row">
                            <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong>
                            <strong id="totalAmount">0.00</strong>
                            <strong>‡∏ö‡∏≤‡∏ó</strong>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <select id="paymentStatus" class="form-input">
                            <option value="‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß">‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß</option>
                            <option value="‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∞</option>
                            <option value="‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô">‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</label>
                        <select id="paymentMethod" class="form-input">
                            <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                            <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
                            <option value="‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï">‡∏ö‡∏±‡∏ï‡∏£‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="billNotes" class="form-input" rows="2"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeBillingModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Receipt Modal -->
    <div id="viewReceiptModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
                <span class="close" onclick="closeViewReceiptModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="receiptContent" class="receipt-print"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeViewReceiptModal()">‡∏õ‡∏¥‡∏î</button>
                    <button type="button" class="btn btn-primary" onclick="printReceipt()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let billings = JSON.parse(localStorage.getItem('billings')) || [];
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let editingBillingId = null;
        let billItemCounter = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadBillings();
            loadPatientSelect();
            updateStats();

            document.getElementById('billDate').valueAsDate = new Date();

            // Search listeners
            document.getElementById('searchBill').addEventListener('input', loadBillings);
            document.getElementById('searchDate').addEventListener('change', loadBillings);

            // Form submission
            document.getElementById('billingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveBilling();
            });
        });

        function loadPatientSelect() {
            patients = JSON.parse(localStorage.getItem('patients')) || [];
            const select = document.getElementById('patientSelect');

            select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>' +
                patients.map(p => `
                    <option value="${p.id}">${p.hn} - ${p.firstName} ${p.lastName}</option>
                `).join('');
        }

        function updateBillPatientInfo() {
            const patientId = document.getElementById('patientSelect').value;
            const infoDiv = document.getElementById('billPatientInfo');

            if (!patientId) {
                infoDiv.innerHTML = '';
                return;
            }

            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                infoDiv.innerHTML = `
                    <div class="info-box">
                        <strong>HN:</strong> ${patient.hn} |
                        <strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${patient.firstName} ${patient.lastName} |
                        <strong>‡πÇ‡∏ó‡∏£:</strong> ${patient.phone}
                    </div>
                `;
            }
        }

        function generateReceiptNumber() {
            const prefix = 'RC';
            const date = new Date();
            const dateStr = date.getFullYear().toString() +
                          (date.getMonth() + 1).toString().padStart(2, '0') +
                          date.getDate().toString().padStart(2, '0');
            const count = billings.filter(b => b.receiptNumber && b.receiptNumber.includes(dateStr)).length + 1;
            return `${prefix}${dateStr}${count.toString().padStart(3, '0')}`;
        }

        function addBillItem() {
            billItemCounter++;
            const container = document.getElementById('billItems');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'bill-item';
            itemDiv.id = `item-${billItemCounter}`;
            itemDiv.innerHTML = `
                <div class="bill-item-row">
                    <input type="text" class="form-input" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£" data-item-id="${billItemCounter}" data-field="description" onchange="calculateTotal()">
                    <input type="number" class="form-input-sm" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="1" min="1" data-item-id="${billItemCounter}" data-field="quantity" onchange="calculateTotal()">
                    <input type="number" class="form-input" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢" value="0" min="0" step="0.01" data-item-id="${billItemCounter}" data-field="price" onchange="calculateTotal()">
                    <span class="item-total">0.00</span>
                    <button type="button" class="btn-icon" onclick="removeBillItem(${billItemCounter})" title="‡∏•‡∏ö">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(itemDiv);
        }

        function removeBillItem(itemId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                item.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            const items = document.querySelectorAll('.bill-item-row');
            let subtotal = 0;

            items.forEach(item => {
                const quantity = parseFloat(item.querySelector('[data-field="quantity"]').value) || 0;
                const price = parseFloat(item.querySelector('[data-field="price"]').value) || 0;
                const itemTotal = quantity * price;

                const totalSpan = item.querySelector('.item-total');
                if (totalSpan) {
                    totalSpan.textContent = itemTotal.toFixed(2);
                }

                subtotal += itemTotal;
            });

            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const total = Math.max(0, subtotal - discount);

            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = discount.toFixed(2);
            document.getElementById('totalAmount').textContent = total.toFixed(2);
        }

        function openAddBillingModal() {
            editingBillingId = null;
            document.getElementById('modalTitle').textContent = '‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('billingForm').reset();
            document.getElementById('receiptNumber').value = generateReceiptNumber();
            document.getElementById('billDate').valueAsDate = new Date();
            document.getElementById('paymentStatus').value = '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß';
            document.getElementById('paymentMethod').value = '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î';
            document.getElementById('billItems').innerHTML = '';
            document.getElementById('billPatientInfo').innerHTML = '';
            billItemCounter = 0;

            // Add one default item
            addBillItem();

            document.getElementById('billingModal').style.display = 'block';
        }

        function closeBillingModal() {
            document.getElementById('billingModal').style.display = 'none';
            document.getElementById('billingForm').reset();
            document.getElementById('billItems').innerHTML = '';
            document.getElementById('billPatientInfo').innerHTML = '';
            editingBillingId = null;
            billItemCounter = 0;
        }

        function saveBilling() {
            const patientId = document.getElementById('patientSelect').value;
            const patient = patients.find(p => p.id === patientId);

            if (!patient) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
                return;
            }

            // Collect bill items
            const itemElements = document.querySelectorAll('.bill-item-row');
            const items = [];

            itemElements.forEach(item => {
                const description = item.querySelector('[data-field="description"]').value;
                const quantity = parseFloat(item.querySelector('[data-field="quantity"]').value) || 0;
                const price = parseFloat(item.querySelector('[data-field="price"]').value) || 0;

                if (description && quantity > 0) {
                    items.push({
                        description: description,
                        quantity: quantity,
                        price: price,
                        total: quantity * price
                    });
                }
            });

            if (items.length === 0) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£');
                return;
            }

            const subtotal = items.reduce((sum, item) => sum + item.total, 0);
            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const total = Math.max(0, subtotal - discount);

            const billing = {
                id: editingBillingId || Date.now().toString(),
                receiptNumber: document.getElementById('receiptNumber').value,
                date: document.getElementById('billDate').value,
                patientId: patientId,
                patientName: `${patient.firstName} ${patient.lastName}`,
                patientHN: patient.hn,
                items: items,
                subtotal: subtotal,
                discount: discount,
                total: total,
                paymentStatus: document.getElementById('paymentStatus').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                notes: document.getElementById('billNotes').value,
                createdAt: editingBillingId ?
                    billings.find(b => b.id === editingBillingId).createdAt :
                    new Date().toISOString()
            };

            if (editingBillingId) {
                const index = billings.findIndex(b => b.id === editingBillingId);
                billings[index] = billing;
            } else {
                billings.push(billing);
            }

            localStorage.setItem('billings', JSON.stringify(billings));
            loadBillings();
            updateStats();
            closeBillingModal();
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function deleteBilling(id) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ô‡∏µ‡πâ?')) {
                billings = billings.filter(b => b.id !== id);
                localStorage.setItem('billings', JSON.stringify(billings));
                loadBillings();
                updateStats();
                showNotification('‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function viewReceipt(id) {
            const billing = billings.find(b => b.id === id);
            if (!billing) return;

            const content = `
                <div class="receipt">
                    <div class="receipt-header">
                        <h2>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
                        <p>Receipt</p>
                    </div>

                    <div class="receipt-info">
                        <div class="receipt-row">
                            <span>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à:</span>
                            <strong>${billing.receiptNumber}</strong>
                        </div>
                        <div class="receipt-row">
                            <span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span>
                            <span>${formatDate(billing.date)}</span>
                        </div>
                    </div>

                    <div class="receipt-patient">
                        <div class="receipt-row">
                            <span>HN:</span>
                            <span>${billing.patientHN}</span>
                        </div>
                        <div class="receipt-row">
                            <span>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</span>
                            <span>${billing.patientName}</span>
                        </div>
                    </div>

                    <table class="receipt-table">
                        <thead>
                            <tr>
                                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                <th>‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                <th>‡∏£‡∏ß‡∏°</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${billing.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.price.toFixed(2)}</td>
                                    <td>${item.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="receipt-summary">
                        <div class="receipt-row">
                            <span>‡∏£‡∏ß‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏á‡∏¥‡∏ô:</span>
                            <span>${billing.subtotal.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                        ${billing.discount > 0 ? `
                            <div class="receipt-row">
                                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                                <span>${billing.discount.toFixed(2)} ‡∏ö‡∏≤‡∏ó</span>
                            </div>
                        ` : ''}
                        <div class="receipt-row total">
                            <strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong>
                            <strong>${billing.total.toFixed(2)} ‡∏ö‡∏≤‡∏ó</strong>
                        </div>
                    </div>

                    <div class="receipt-payment">
                        <div class="receipt-row">
                            <span>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</span>
                            <span>${billing.paymentMethod}</span>
                        </div>
                        <div class="receipt-row">
                            <span>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                            <span class="status-${billing.paymentStatus.replace(/\s/g, '')}">${billing.paymentStatus}</span>
                        </div>
                    </div>

                    ${billing.notes ? `
                        <div class="receipt-notes">
                            <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${billing.notes}
                        </div>
                    ` : ''}

                    <div class="receipt-footer">
                        <p>‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
                    </div>
                </div>
            `;

            document.getElementById('receiptContent').innerHTML = content;
            document.getElementById('viewReceiptModal').style.display = 'block';
        }

        function closeViewReceiptModal() {
            document.getElementById('viewReceiptModal').style.display = 'none';
        }

        function printReceipt() {
            window.print();
        }

        function updateStats() {
            billings = JSON.parse(localStorage.getItem('billings')) || [];

            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().substring(0, 7);

            // Today's income and count
            const todayBills = billings.filter(b => b.date === today && b.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß');
            const todayIncome = todayBills.reduce((sum, b) => sum + parseFloat(b.total || 0), 0);

            document.getElementById('todayIncome').textContent = todayIncome.toLocaleString() + ' ‡∏ø';
            document.getElementById('todayBillCount').textContent = todayBills.length;

            // Monthly income
            const monthlyBills = billings.filter(b =>
                b.date && b.date.startsWith(currentMonth) && b.paymentStatus === '‡∏ä‡∏≥‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß'
            );
            const monthlyIncome = monthlyBills.reduce((sum, b) => sum + parseFloat(b.total || 0), 0);

            document.getElementById('monthlyIncome').textContent = monthlyIncome.toLocaleString() + ' ‡∏ø';
        }

        function loadBillings() {
            billings = JSON.parse(localStorage.getItem('billings')) || [];

            const searchTerm = document.getElementById('searchBill').value.toLowerCase();
            const searchDate = document.getElementById('searchDate').value;

            let filtered = billings;

            if (searchTerm) {
                filtered = filtered.filter(b =>
                    b.receiptNumber.toLowerCase().includes(searchTerm) ||
                    b.patientHN.toLowerCase().includes(searchTerm) ||
                    b.patientName.toLowerCase().includes(searchTerm)
                );
            }

            if (searchDate) {
                filtered = filtered.filter(b => b.date === searchDate);
            }

            // Sort by date (newest first)
            filtered.sort((a, b) => b.date.localeCompare(a.date));

            displayBillings(filtered);
        }

        function displayBillings(billingList) {
            const tbody = document.getElementById('billTableBody');
            document.getElementById('billCount').textContent = `${billingList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (billingList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</td></tr>';
                return;
            }

            tbody.innerHTML = billingList.map(bill => {
                const itemsSummary = bill.items.length > 0 ?
                    bill.items.map(i => i.description).join(', ') :
                    '-';

                return `
                    <tr>
                        <td><strong>${bill.receiptNumber}</strong></td>
                        <td>${formatDate(bill.date)}</td>
                        <td>${bill.patientHN}</td>
                        <td>${bill.patientName}</td>
                        <td>${itemsSummary.substring(0, 30)}${itemsSummary.length > 30 ? '...' : ''}</td>
                        <td><strong>${bill.total.toLocaleString()} ‡∏ø</strong></td>
                        <td><span class="status-badge status-${bill.paymentStatus.replace(/\s/g, '')}">${bill.paymentStatus}</span></td>
                        <td>
                            <button class="btn-icon" onclick="viewReceipt('${bill.id}')" title="‡∏î‡∏π‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à">üëÅÔ∏è</button>
                            <button class="btn-icon" onclick="deleteBilling('${bill.id}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function clearSearch() {
            document.getElementById('searchBill').value = '';
            document.getElementById('searchDate').value = '';
            loadBillings();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const billingModal = document.getElementById('billingModal');
            const receiptModal = document.getElementById('viewReceiptModal');

            if (event.target === billingModal) {
                closeBillingModal();
            }
            if (event.target === receiptModal) {
                closeViewReceiptModal();
            }
        }
    </script>
</body>
</html>
