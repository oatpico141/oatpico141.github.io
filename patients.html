<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html">üìä Dashboard</a></li>
            <li><a href="patients.html" class="active">üë• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
            <li><a href="appointments.html">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
            <li><a href="records.html">üìã ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></li>
            <li><a href="billing.html">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>üë• ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h2>
            <button class="btn btn-primary" onclick="openAddPatientModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
            </div>
            <div class="card-body">
                <input type="text" id="searchPatient" class="form-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏î‡πâ‡∏ß‡∏¢ HN, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå...">
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>
                <span class="badge" id="patientCount">0 ‡∏Ñ‡∏ô</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>HN</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th>‡∏≠‡∏≤‡∏¢‡∏∏</th>
                                <th>‡πÄ‡∏û‡∏®</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="patientTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Patient Modal -->
    <div id="patientModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h3>
                <span class="close" onclick="closePatientModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="patientForm">
                    <input type="hidden" id="patientId">

                    <div class="form-group">
                        <label>HN (Hospital Number)</label>
                        <input type="text" id="hn" class="form-input" readonly>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏ä‡∏∑‡πà‡∏≠ <span class="required">*</span></label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• <span class="required">*</span></label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô/‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/‡∏õ‡∏µ‡πÄ‡∏Å‡∏¥‡∏î <span class="required">*</span></label>
                            <input type="date" id="birthDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏û‡∏® <span class="required">*</span></label>
                            <select id="gender" class="form-input" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏®</option>
                                <option value="‡∏ä‡∏≤‡∏¢">‡∏ä‡∏≤‡∏¢</option>
                                <option value="‡∏´‡∏ç‡∏¥‡∏á">‡∏´‡∏ç‡∏¥‡∏á</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
                            <input type="text" id="idCard" class="form-input" maxlength="13">
                        </div>
                        <div class="form-group">
                            <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå <span class="required">*</span></label>
                            <input type="tel" id="phone" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                        <textarea id="address" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</label>
                        <textarea id="chronicDiseases" class="form-input" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô‡πÇ‡∏•‡∏´‡∏¥‡∏ï‡∏™‡∏π‡∏á, ‡πÄ‡∏ö‡∏≤‡∏´‡∏ß‡∏≤‡∏ô"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡πÅ‡∏û‡πâ‡∏¢‡∏≤</label>
                        <textarea id="allergies" class="form-input" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏û‡πâ"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="notes" class="form-input" rows="2"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closePatientModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let editingPatientId = null;

        // Load patients on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();

            // Search functionality
            document.getElementById('searchPatient').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filteredPatients = patients.filter(p =>
                    p.hn.toLowerCase().includes(searchTerm) ||
                    p.firstName.toLowerCase().includes(searchTerm) ||
                    p.lastName.toLowerCase().includes(searchTerm) ||
                    p.phone.includes(searchTerm) ||
                    (p.idCard && p.idCard.includes(searchTerm))
                );
                displayPatients(filteredPatients);
            });

            // Form submission
            document.getElementById('patientForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePatient();
            });
        });

        function generateHN() {
            const prefix = 'HN';
            const timestamp = Date.now().toString().slice(-6);
            return prefix + timestamp;
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function openAddPatientModal() {
            editingPatientId = null;
            document.getElementById('modalTitle').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('patientForm').reset();
            document.getElementById('hn').value = generateHN();
            document.getElementById('patientModal').style.display = 'block';
        }

        function openEditPatientModal(id) {
            editingPatientId = id;
            const patient = patients.find(p => p.id === id);

            if (patient) {
                document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢';
                document.getElementById('patientId').value = patient.id;
                document.getElementById('hn').value = patient.hn;
                document.getElementById('firstName').value = patient.firstName;
                document.getElementById('lastName').value = patient.lastName;
                document.getElementById('birthDate').value = patient.birthDate;
                document.getElementById('gender').value = patient.gender;
                document.getElementById('idCard').value = patient.idCard || '';
                document.getElementById('phone').value = patient.phone;
                document.getElementById('address').value = patient.address || '';
                document.getElementById('chronicDiseases').value = patient.chronicDiseases || '';
                document.getElementById('allergies').value = patient.allergies || '';
                document.getElementById('notes').value = patient.notes || '';

                document.getElementById('patientModal').style.display = 'block';
            }
        }

        function closePatientModal() {
            document.getElementById('patientModal').style.display = 'none';
            document.getElementById('patientForm').reset();
            editingPatientId = null;
        }

        function savePatient() {
            const patient = {
                id: editingPatientId || Date.now().toString(),
                hn: document.getElementById('hn').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                birthDate: document.getElementById('birthDate').value,
                gender: document.getElementById('gender').value,
                idCard: document.getElementById('idCard').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                chronicDiseases: document.getElementById('chronicDiseases').value,
                allergies: document.getElementById('allergies').value,
                notes: document.getElementById('notes').value,
                registeredDate: editingPatientId ?
                    patients.find(p => p.id === editingPatientId).registeredDate :
                    new Date().toISOString().split('T')[0]
            };

            if (editingPatientId) {
                const index = patients.findIndex(p => p.id === editingPatientId);
                patients[index] = patient;
            } else {
                patients.push(patient);
            }

            localStorage.setItem('patients', JSON.stringify(patients));
            loadPatients();
            closePatientModal();
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function deletePatient(id) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ?')) {
                patients = patients.filter(p => p.id !== id);
                localStorage.setItem('patients', JSON.stringify(patients));
                loadPatients();
                showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function loadPatients() {
            patients = JSON.parse(localStorage.getItem('patients')) || [];
            displayPatients(patients);
        }

        function displayPatients(patientList) {
            const tbody = document.getElementById('patientTableBody');
            document.getElementById('patientCount').textContent = `${patientList.length} ‡∏Ñ‡∏ô`;

            if (patientList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</td></tr>';
                return;
            }

            tbody.innerHTML = patientList.map(patient => `
                <tr>
                    <td><strong>${patient.hn}</strong></td>
                    <td>${patient.firstName} ${patient.lastName}</td>
                    <td>${calculateAge(patient.birthDate)} ‡∏õ‡∏µ</td>
                    <td>${patient.gender}</td>
                    <td>${patient.phone}</td>
                    <td>${formatDate(patient.registeredDate)}</td>
                    <td>
                        <button class="btn-icon" onclick="openEditPatientModal('${patient.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deletePatient('${patient.id}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('patientModal');
            if (event.target === modal) {
                closePatientModal();
            }
        }
    </script>
</body>
</html>
