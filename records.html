<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô - ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üè• ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å</h1>
        </div>
        <ul class="nav-menu">
            <li><a href="index.html">üìä Dashboard</a></li>
            <li><a href="patients.html">üë• ‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</a></li>
            <li><a href="appointments.html">üìÖ ‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢</a></li>
            <li><a href="records.html" class="active">üìã ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a></li>
            <li><a href="billing.html">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô/‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="page-header">
            <h2>üìã ‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h2>
            <button class="btn btn-primary" onclick="openAddRecordModal()">+ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
            </div>
            <div class="card-body">
                <div class="search-bar">
                    <select id="searchPatient" class="form-input">
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                    </select>
                    <input type="date" id="searchDate" class="form-input" placeholder="‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà">
                    <button class="btn btn-secondary" onclick="clearSearch()">‡∏•‡πâ‡∏≤‡∏á</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <span class="badge" id="recordCount">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th>HN</th>
                                <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</th>
                                <th>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£</th>
                                <th>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢</th>
                                <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="recordTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Record Modal -->
    <div id="recordModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="modalTitle">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
                <span class="close" onclick="closeRecordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="recordForm">
                    <input type="hidden" id="recordId">

                    <div class="form-group">
                        <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ <span class="required">*</span></label>
                        <select id="patientSelect" class="form-input" required onchange="updatePatientDetails()">
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>
                        </select>
                        <div id="patientDetails" class="patient-details"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="required">*</span></label>
                            <input type="date" id="recordDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>‡πÄ‡∏ß‡∏•‡∏≤ <span class="required">*</span></label>
                            <input type="time" id="recordTime" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç / Chief Complaint <span class="required">*</span></label>
                        <textarea id="chiefComplaint" class="form-input" rows="2" required placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏ß‡∏î‡∏ó‡πâ‡∏≠‡∏á, ‡πÑ‡∏Ç‡πâ‡∏™‡∏π‡∏á, ‡πÑ‡∏≠"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô / Present Illness</label>
                        <textarea id="presentIllness" class="form-input" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)</label>
                            <input type="number" id="temperature" class="form-input" step="0.1" placeholder="36.5">
                        </div>
                        <div class="form-group">
                            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô (mmHg)</label>
                            <input type="text" id="bloodPressure" class="form-input" placeholder="120/80">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>‡∏ä‡∏µ‡∏û‡∏à‡∏£ (‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                            <input type="number" id="pulse" class="form-input" placeholder="72">
                        </div>
                        <div class="form-group">
                            <label>‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å (‡∏Å‡∏Å.)</label>
                            <input type="number" id="weight" class="form-input" step="0.1" placeholder="65">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ / Physical Examination</label>
                        <textarea id="physicalExam" class="form-input" rows="3"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ / Diagnosis <span class="required">*</span></label>
                        <textarea id="diagnosis" class="form-input" rows="2" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Acute gastritis"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ / Treatment</label>
                        <textarea id="treatment" class="form-input" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</label>
                        <textarea id="followUp" class="form-input" rows="2"></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                        <textarea id="recordNotes" class="form-input" rows="2"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeRecordModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button type="submit" class="btn btn-primary">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- View Record Detail Modal -->
    <div id="viewRecordModal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>
                <span class="close" onclick="closeViewRecordModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="recordDetailContent"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeViewRecordModal()">‡∏õ‡∏¥‡∏î</button>
                    <button type="button" class="btn btn-primary" onclick="printRecord()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        let records = JSON.parse(localStorage.getItem('medicalRecords')) || [];
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let editingRecordId = null;
        let viewingRecord = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            loadPatientSelects();

            // Set default date/time
            const now = new Date();
            document.getElementById('recordDate').valueAsDate = now;
            document.getElementById('recordTime').value = now.toTimeString().slice(0, 5);

            // Search listeners
            document.getElementById('searchPatient').addEventListener('change', loadRecords);
            document.getElementById('searchDate').addEventListener('change', loadRecords);

            // Form submission
            document.getElementById('recordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveRecord();
            });
        });

        function loadPatientSelects() {
            patients = JSON.parse(localStorage.getItem('patients')) || [];

            const selects = [
                document.getElementById('patientSelect'),
                document.getElementById('searchPatient')
            ];

            selects.forEach(select => {
                const currentValue = select.value;
                const isSearch = select.id === 'searchPatient';

                select.innerHTML = (isSearch ? '<option value="">-- ‡∏ó‡∏∏‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>' : '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ --</option>') +
                    patients.map(p => `
                        <option value="${p.id}">${p.hn} - ${p.firstName} ${p.lastName}</option>
                    `).join('');

                select.value = currentValue;
            });
        }

        function updatePatientDetails() {
            const patientId = document.getElementById('patientSelect').value;
            const detailsDiv = document.getElementById('patientDetails');

            if (!patientId) {
                detailsDiv.innerHTML = '';
                return;
            }

            const patient = patients.find(p => p.id === patientId);
            if (patient) {
                const age = calculateAge(patient.birthDate);
                detailsDiv.innerHTML = `
                    <div class="info-box">
                        <strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong><br>
                        HN: ${patient.hn} | ‡πÄ‡∏û‡∏®: ${patient.gender} | ‡∏≠‡∏≤‡∏¢‡∏∏: ${age} ‡∏õ‡∏µ | ‡πÇ‡∏ó‡∏£: ${patient.phone}<br>
                        ${patient.chronicDiseases ? `‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß: ${patient.chronicDiseases}<br>` : ''}
                        ${patient.allergies ? `<span class="alert-text">‚ö†Ô∏è ‡πÅ‡∏û‡πâ‡∏¢‡∏≤: ${patient.allergies}</span>` : ''}
                    </div>
                `;
            }
        }

        function calculateAge(birthDate) {
            const today = new Date();
            const birth = new Date(birthDate);
            let age = today.getFullYear() - birth.getFullYear();
            const monthDiff = today.getMonth() - birth.getMonth();
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                age--;
            }
            return age;
        }

        function openAddRecordModal() {
            editingRecordId = null;
            document.getElementById('modalTitle').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÉ‡∏´‡∏°‡πà';
            document.getElementById('recordForm').reset();

            const now = new Date();
            document.getElementById('recordDate').valueAsDate = now;
            document.getElementById('recordTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('patientDetails').innerHTML = '';

            document.getElementById('recordModal').style.display = 'block';
        }

        function openEditRecordModal(id) {
            editingRecordId = id;
            const record = records.find(r => r.id === id);

            if (record) {
                document.getElementById('modalTitle').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô';
                document.getElementById('recordId').value = record.id;
                document.getElementById('patientSelect').value = record.patientId;
                updatePatientDetails();
                document.getElementById('recordDate').value = record.date;
                document.getElementById('recordTime').value = record.time;
                document.getElementById('chiefComplaint').value = record.chiefComplaint;
                document.getElementById('presentIllness').value = record.presentIllness || '';
                document.getElementById('temperature').value = record.temperature || '';
                document.getElementById('bloodPressure').value = record.bloodPressure || '';
                document.getElementById('pulse').value = record.pulse || '';
                document.getElementById('weight').value = record.weight || '';
                document.getElementById('physicalExam').value = record.physicalExam || '';
                document.getElementById('diagnosis').value = record.diagnosis;
                document.getElementById('treatment').value = record.treatment || '';
                document.getElementById('followUp').value = record.followUp || '';
                document.getElementById('recordNotes').value = record.notes || '';

                document.getElementById('recordModal').style.display = 'block';
            }
        }

        function closeRecordModal() {
            document.getElementById('recordModal').style.display = 'none';
            document.getElementById('recordForm').reset();
            document.getElementById('patientDetails').innerHTML = '';
            editingRecordId = null;
        }

        function saveRecord() {
            const patientId = document.getElementById('patientSelect').value;
            const patient = patients.find(p => p.id === patientId);

            if (!patient) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
                return;
            }

            const record = {
                id: editingRecordId || Date.now().toString(),
                patientId: patientId,
                patientName: `${patient.firstName} ${patient.lastName}`,
                patientHN: patient.hn,
                date: document.getElementById('recordDate').value,
                time: document.getElementById('recordTime').value,
                chiefComplaint: document.getElementById('chiefComplaint').value,
                presentIllness: document.getElementById('presentIllness').value,
                temperature: document.getElementById('temperature').value,
                bloodPressure: document.getElementById('bloodPressure').value,
                pulse: document.getElementById('pulse').value,
                weight: document.getElementById('weight').value,
                physicalExam: document.getElementById('physicalExam').value,
                diagnosis: document.getElementById('diagnosis').value,
                treatment: document.getElementById('treatment').value,
                followUp: document.getElementById('followUp').value,
                notes: document.getElementById('recordNotes').value,
                createdAt: editingRecordId ?
                    records.find(r => r.id === editingRecordId).createdAt :
                    new Date().toISOString()
            };

            if (editingRecordId) {
                const index = records.findIndex(r => r.id === editingRecordId);
                records[index] = record;
            } else {
                records.push(record);
            }

            localStorage.setItem('medicalRecords', JSON.stringify(records));
            loadRecords();
            closeRecordModal();
            showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        }

        function deleteRecord(id) {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ?')) {
                records = records.filter(r => r.id !== id);
                localStorage.setItem('medicalRecords', JSON.stringify(records));
                loadRecords();
                showNotification('‡∏•‡∏ö‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            }
        }

        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            viewingRecord = record;
            const patient = patients.find(p => p.id === record.patientId);

            const content = `
                <div class="record-detail">
                    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h4>
                    <p><strong>HN:</strong> ${record.patientHN}</p>
                    <p><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> ${record.patientName}</p>
                    ${patient ? `
                        <p><strong>‡∏≠‡∏≤‡∏¢‡∏∏:</strong> ${calculateAge(patient.birthDate)} ‡∏õ‡∏µ | <strong>‡πÄ‡∏û‡∏®:</strong> ${patient.gender}</p>
                        ${patient.allergies ? `<p class="alert-text"><strong>‚ö†Ô∏è ‡πÅ‡∏û‡πâ‡∏¢‡∏≤:</strong> ${patient.allergies}</p>` : ''}
                    ` : ''}

                    <hr>
                    <h4>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</h4>
                    <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${formatDate(record.date)} <strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${record.time}</p>

                    <h5>‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Chief Complaint):</h5>
                    <p>${record.chiefComplaint}</p>

                    ${record.presentIllness ? `
                        <h5>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (Present Illness):</h5>
                        <p>${record.presentIllness}</p>
                    ` : ''}

                    <h5>‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ä‡∏µ‡∏û (Vital Signs):</h5>
                    <p>
                        ${record.temperature ? `‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥: ${record.temperature} ¬∞C | ` : ''}
                        ${record.bloodPressure ? `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏ô: ${record.bloodPressure} mmHg | ` : ''}
                        ${record.pulse ? `‡∏ä‡∏µ‡∏û‡∏à‡∏£: ${record.pulse} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á/‡∏ô‡∏≤‡∏ó‡∏µ | ` : ''}
                        ${record.weight ? `‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${record.weight} ‡∏Å‡∏Å.` : ''}
                    </p>

                    ${record.physicalExam ? `
                        <h5>‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ (Physical Examination):</h5>
                        <p>${record.physicalExam}</p>
                    ` : ''}

                    <h5>‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢ (Diagnosis):</h5>
                    <p><strong>${record.diagnosis}</strong></p>

                    ${record.treatment ? `
                        <h5>‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤ (Treatment):</h5>
                        <p>${record.treatment}</p>
                    ` : ''}

                    ${record.followUp ? `
                        <h5>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ:</h5>
                        <p>${record.followUp}</p>
                    ` : ''}

                    ${record.notes ? `
                        <h5>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</h5>
                        <p>${record.notes}</p>
                    ` : ''}
                </div>
            `;

            document.getElementById('recordDetailContent').innerHTML = content;
            document.getElementById('viewRecordModal').style.display = 'block';
        }

        function closeViewRecordModal() {
            document.getElementById('viewRecordModal').style.display = 'none';
            viewingRecord = null;
        }

        function printRecord() {
            window.print();
        }

        function loadRecords() {
            records = JSON.parse(localStorage.getItem('medicalRecords')) || [];

            const searchPatientId = document.getElementById('searchPatient').value;
            const searchDate = document.getElementById('searchDate').value;

            let filtered = records;

            if (searchPatientId) {
                filtered = filtered.filter(r => r.patientId === searchPatientId);
            }

            if (searchDate) {
                filtered = filtered.filter(r => r.date === searchDate);
            }

            // Sort by date and time (newest first)
            filtered.sort((a, b) => {
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                return b.time.localeCompare(a.time);
            });

            displayRecords(filtered);
        }

        function displayRecords(recordList) {
            const tbody = document.getElementById('recordTableBody');
            document.getElementById('recordCount').textContent = `${recordList.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;

            if (recordList.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏ß‡∏ä‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>';
                return;
            }

            tbody.innerHTML = recordList.map(record => `
                <tr>
                    <td>${formatDate(record.date)}</td>
                    <td>${record.time}</td>
                    <td>${record.patientHN}</td>
                    <td>${record.patientName}</td>
                    <td>${record.chiefComplaint}</td>
                    <td><strong>${record.diagnosis}</strong></td>
                    <td>
                        <button class="btn-icon" onclick="viewRecord('${record.id}')" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">üëÅÔ∏è</button>
                        <button class="btn-icon" onclick="openEditRecordModal('${record.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteRecord('${record.id}')" title="‡∏•‡∏ö">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('searchPatient').value = '';
            document.getElementById('searchDate').value = '';
            loadRecords();
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const recordModal = document.getElementById('recordModal');
            const viewModal = document.getElementById('viewRecordModal');

            if (event.target === recordModal) {
                closeRecordModal();
            }
            if (event.target === viewModal) {
                closeViewRecordModal();
            }
        }
    </script>
</body>
</html>
